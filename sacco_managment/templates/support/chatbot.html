{% extends 'partials/dashboard-base.html' %}
{% load static %}

{% block content %}

<div class="page-body">
      {% include 'layout/breadcrumb.html' %}
  <div class="col-lg-12 featured-tutorial">
    <div class="header-faq">
      <h3 class="mb-0">GEMS AI</h3>
      <p class="mb-4">Chat with GEMS AI like you're messaging a friend.</p>
    </div>

    <div class="row justify-content-center">
      <div class="col-xl-6 col-md-8">
        <div class="card product-box">
          <div class="card-body p-0">
            <div id="chatbox" class="chat-box p-3" style="height: 450px; overflow-y: auto; background: #f5f5f5; border-radius: 10px 10px 0 0;">
              <!-- Messages will appear here -->
            </div>
            <div class="input-group p-3 border-top" style="border-radius: 0 0 10px 10px; background: #fff;">
              <input type="text" id="user-input" class="form-control" placeholder="Type your message..." />
              <button class="btn btn-primary" id="send-btn"><i class="fa fa-paper-plane"></i></button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .chat-box {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .chat-bubble {
    max-width: 75%;
    padding: 10px 15px;
    border-radius: 18px;
    line-height: 1.4;
    word-wrap: break-word;
    font-size: 0.95rem;
    opacity: 0;
    animation: fadeIn 0.3s forwards;
  }

  .user-bubble {
    background-color: #d1f0ff;
    color: #000;
    align-self: flex-end;
    margin-left: auto;
    border-bottom-right-radius: 2px;
  }

  .bot-bubble {
    background-color: #e8f5e9;
    color: #000;
    align-self: flex-start;
    margin-right: auto;
    border-bottom-left-radius: 2px;
  }

  .typing-indicator {
    font-style: italic;
    font-size: 0.9rem;
    color: #555;
    padding-left: 10px;
  }

  @keyframes fadeIn {
    to {
      opacity: 1;
    }
  }
</style>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const chatbox = document.getElementById('chatbox');
  const input = document.getElementById('user-input');
  const sendBtn = document.getElementById('send-btn');

  function scrollChatToBottom() {
    chatbox.scrollTop = chatbox.scrollHeight;
  }

  function addMessage(content, type) {
    const div = document.createElement('div');
    div.className = `chat-bubble ${type}-bubble`;
    div.textContent = content;
    chatbox.appendChild(div);
    scrollChatToBottom();
  }

  function sendMessage(message) {
    if (!message.trim()) return;

    addMessage(message, 'user');
    input.value = '';

    // Show typing indicator
    const typing = document.createElement('div');
    typing.className = 'chat-bubble bot-bubble typing-indicator';
    typing.id = 'typing';
    typing.innerHTML = 'GEMS AI is typing...';
    chatbox.appendChild(typing);
    scrollChatToBottom();

    fetch("{% url 'support:chatbot' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: new URLSearchParams({ message: message })
    })
    .then(res => res.json())
    .then(data => {
      document.getElementById('typing').remove();
      addMessage(data.reply, 'bot');
    })
    .catch(() => {
      document.getElementById('typing').remove();
      addMessage('GEMS AI is not available at the moment. Please try again later.', 'bot');
    });
  }

  sendBtn.addEventListener('click', () => sendMessage(input.value));
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage(input.value);
  });
</script>

{% endblock %}
